<div class="task-container">
    <div class="task-header">
        <h2>ğŸ—“ï¸ <%= title %></h2>
        <div class="task-counter-container">
            <span class="counter-item">âœ… ConcluÃ­das: <strong id="completed-count">0</strong></span>
            <span class="counter-item">ğŸ•’ Pendentes: <strong id="pending-count">0</strong></span>
            <span class="counter-item">ğŸ“¦ Total: <strong id="total-count">0</strong></span>
        </div>
    </div>
    <div class="user-greeting">
        <% if (locals.currentUserName) { %>
            <p>Logado como: <strong><%= currentUserName %></strong></p>
        <% } %>
    </div>

    <div class="task-container-header">
        <button id="add-task-modal-btn" class="header-btn btn-add">ï¼‹ Adicionar</button>
        <a href="/dashboard" class="header-btn btn-dash">ğŸ“Š Dashboard</a>
        
        <a href="/api/tarefas/exportar" class="header-btn btn-tool" title="Baixar CSV">ğŸ“„ CSV</a>
        <a href="/api/tarefas/exportar-json" class="header-btn btn-tool" title="Baixar JSON">âš™ï¸ JSON</a>
        <a href="/api/tarefas/backup" class="header-btn btn-tool" title="Backup">ğŸ’¾ Backup</a>
        
        <button onclick="document.getElementById('inputImportar').click()" class="header-btn btn-tool">ğŸ“¥ Importar</button>
        <input type="file" id="inputImportar" style="display: none;" accept=".json" onchange="enviarImportacao(this)">
    </div>

    <ul id="task-list" class="task-list">
        <% if (tasks && tasks.length > 0) { %>
            <% tasks.forEach(task => { %>
                <% const prioridade = task.prioridade || 'MÃ©dia'; %>
                <% const prioridadeClass = prioridade.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); %>
                <li class="task-card <%= task.concluida ? 'completed' : '' %>" data-id="<%= task._id %>">
                    <input type="checkbox" class="task-checkbox" <%= task.concluida ? 'checked' : '' %>>
                    <div class="task-content">
                        <h3 class="task-title"><%= task.titulo %></h3>
                        <p class="task-description">
                            <%- task.descricao ? task.descricao.replace(/\n/g, '<br>') : '' %>
                            <br>
                            <small class="task-creation-date">
                                <em>Criada em: <%= formatDate(task.createdAt) %></em>
                                <% if (task.user && task.user.nome) { %>
                                    <span class="task-author">
                                        <em>por: <%= task.user.nome %></em>
                                    </span>
                                <% } %>
                            </small>
                        </p>
                    </div>
                    <div class="task-meta">
                        <span class="priority-tag priority-<%= prioridadeClass %>"><%= prioridade %></span>
                        <% if (locals.currentUserRole === 'admin' || (task.user && task.user._id.toString() === locals.currentUserId.toString())) { %>
                            <button class="delete-btn" title="Excluir tarefa">ğŸ—‘ï¸</button>
                        <% } else { %>
                            <button class="delete-btn" disabled title="VocÃª nÃ£o tem permissÃ£o para excluir esta tarefa">ğŸ—‘ï¸</button>
                        <% } %>
                    </div>
                </li>
            <% }) %>
        <% } %>
    </ul>
</div>

<%- contentFor('modals') %>

<div id="add-task-modal" class="modal">
    <div class="modal-content">
        <span id="close-modal-btn" class="close-btn">&times;</span>
        <h3>Criar Novo Item</h3>
        <form id="task-form">
            <div class="form-group">
                <label for="titulo">TÃ­tulo</label>
                <input type="text" id="titulo" name="titulo" required>
            </div>
            <div class="form-group">
                <label for="descricao">DescriÃ§Ã£o</label>
                <textarea id="descricao" name="descricao"></textarea>
            </div>

            <div class="form-group">
                <label for="category">Categoria</label>
                <select id="category" name="category">
                    <option value="Tarefa" selected>Tarefa</option>
                    <option value="Meu TCC">Meu TCC</option>
                    <option value="Trabalho">Trabalho</option>
                    <option value="Carro">Carro</option>
                </select>
            </div>

            <div class="form-group">
                <label for="prioridade">Prioridade</label>
                <select id="prioridade" name="prioridade">
                    <option value="Baixa">Baixa</option>
                    <option value="MÃ©dia" selected>MÃ©dia</option>
                    <option value="Alta">Alta</option>
                </select>
            </div>
            <button type="submit">Salvar Item</button>
        </form>
    </div>
</div>

<div id="confirm-delete-modal" class="modal">
    <div class="modal-content">
        <h3>Confirmar ExclusÃ£o</h3>
        <p>VocÃª tem certeza que deseja excluir este item?</p>
        <div class="modal-buttons">
            <button id="cancel-delete-btn">Cancelar</button>
            <button id="confirm-delete-btn" class="btn-confirm-delete">Excluir</button>
        </div>
    </div>
</div>

<script>
    // FUNÃ‡ÃƒO DE IMPORTAÃ‡ÃƒO (NOVA)
    async function enviarImportacao(input) {
        const arquivo = input.files[0];
        if (!arquivo) return;
        
        const leitor = new FileReader();
        leitor.onload = async function(e) {
            try {
                const dados = JSON.parse(e.target.result);
                const resposta = await fetch('/api/tarefas/importar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });
                const resultado = await resposta.json();
                
                if (resultado.success) {
                    alert(`ImportaÃ§Ã£o concluÃ­da!\nCriadas: ${resultado.resumo.criadas}\nFalhas: ${resultado.resumo.falhas}`);
                    window.location.reload();
                } else {
                    alert('Erro na importaÃ§Ã£o: ' + (resultado.message || 'Erro desconhecido'));
                }
            } catch (erro) {
                console.error(erro);
                alert('Erro ao ler o arquivo JSON.');
            }
        };
        leitor.readAsText(arquivo);
    }

    // SCRIPT ORIGINAL
    document.addEventListener('DOMContentLoaded', () => {
        const taskList = document.getElementById('task-list');
        const addTaskModal = document.getElementById('add-task-modal');
        const openModalBtn = document.getElementById('add-task-modal-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const taskForm = document.getElementById('task-form');
        const confirmDeleteModal = document.getElementById('confirm-delete-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const completedCountEl = document.getElementById('completed-count');
        const pendingCountEl = document.getElementById('pending-count');
        const totalCountEl = document.getElementById('total-count');
        let taskToDeleteId = null;

        const formatDate = (date) => {
            if (!date) return '';
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            const hours = String(d.getHours()).padStart(2, '0');
            const minutes = String(d.getMinutes()).padStart(2, '0');
            return `${day}/${month}/${year} ${hours}:${minutes}`;
        };

        const updateTaskCounter = () => {
            const totalTasks = document.querySelectorAll('.task-card:not(.removing)').length;
            const completedTasks = document.querySelectorAll('.task-card.completed').length;
            const pendingTasks = totalTasks - completedTasks;
            if (completedCountEl) completedCountEl.textContent = completedTasks;
            if (pendingCountEl) pendingCountEl.textContent = pendingTasks;
            if (totalCountEl) totalCountEl.textContent = totalTasks;
        };

        const renderTask = (task) => {
            const emptyMessage = document.getElementById('empty-message');
            if (emptyMessage) emptyMessage.remove();

            const prioridade = task.prioridade || 'MÃ©dia';
            const prioridadeClass = prioridade.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            
            const li = document.createElement('li');
            li.className = `task-card ${task.concluida ? 'completed' : ''}`;
            li.dataset.id = task._id;
            
                let authorHtml = '';
            if (task.user && task.user.nome) {
                authorHtml = `
                    <span class="task-author">
                        <em>por: ${task.user.nome}</em>
                    </span>
                `;
            }

            const currentUserRole = '<%= locals.currentUserRole %>';
            const currentUserId = '<%= locals.currentUserId %>';
            let deleteButtonHtml = `<button class="delete-btn" disabled title="VocÃª nÃ£o tem permissÃ£o">ğŸ—‘ï¸</button>`;
            
            if (currentUserRole === 'admin' || (task.user && task.user._id.toString() === currentUserId)) {
                deleteButtonHtml = `<button class="delete-btn" title="Excluir tarefa">ğŸ—‘ï¸</button>`;
            }
                
            li.innerHTML = `
                <input type="checkbox" class="task-checkbox" ${task.concluida ? 'checked' : ''}>
                <div class="task-content">
                    <h3 class="task-title">${task.titulo}</h3>
                    <p class="task-description">
                        ${task.descricao ? task.descricao.replace(/\n/g, '<br>') : ''}
                        <br>
                        <small class="task-creation-date">
                            <em>Criada em: ${formatDate(task.createdAt)}</em>
                            ${authorHtml}
                        </small>
                    </p>
                </div>
                <div class="task-meta">
                    <span class="priority-tag priority-${prioridadeClass}">${prioridade}</span>
                    ${deleteButtonHtml}
                </div>
            `;

            const taskList = document.getElementById('task-list');
            taskList.prepend(li);
            updateTaskCounter();
        };

        if (openModalBtn) openModalBtn.onclick = () => { if (addTaskModal) addTaskModal.style.display = 'block'; };
        if (closeModalBtn) closeModalBtn.onclick = () => { if (addTaskModal) addTaskModal.style.display = 'none'; };
        if (cancelDeleteBtn) cancelDeleteBtn.onclick = () => {
            if (confirmDeleteModal) confirmDeleteModal.style.display = 'none';
            taskToDeleteId = null;
        };
        window.onclick = (event) => {
            if (event.target == addTaskModal) addTaskModal.style.display = 'none';
            if (event.target == confirmDeleteModal) {
                confirmDeleteModal.style.display = 'none';
                taskToDeleteId = null;
            }
        };

        if (taskForm) {
            taskForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const titulo = e.target.titulo.value.trim();
                if (!titulo) return;
                
                const taskData = {
                    titulo,
                    descricao: e.target.descricao.value.trim(),
                    prioridade: e.target.prioridade.value,
                    category: e.target.category.value
                };
                
                try {
                    const res = await fetch('/api/tarefas', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(taskData)
                    });
                    const result = await res.json();
                    if (!result.success) throw new Error(result.message);

                    const newCategory = result.data.category;
                    const currentPath = window.location.pathname;

                    if (
                        (currentPath === '/tarefas' && newCategory === 'Tarefa') ||
                        (currentPath === '/tcc' && newCategory === 'Meu TCC') ||
                        (currentPath === '/trabalho' && newCategory === 'Trabalho') ||
                        (currentPath === '/carro' && newCategory === 'Carro')
                    ) {
                        renderTask(result.data);
                    }

                    taskForm.reset();
                    if (addTaskModal) addTaskModal.style.display = 'none';
                    updateTaskCounter();
                } catch (error) {
                    console.error('Falha ao adicionar item:', error);
                }
            });
        }
        
        if (taskList) {
            taskList.addEventListener('click', async (e) => {
                const card = e.target.closest('.task-card');
                if (!card) return;
                const id = card.dataset.id;
                if (e.target.classList.contains('task-checkbox')) {
                    const isCompleted = e.target.checked;
                    try {
                        const res = await fetch(`/api/tarefas/${id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ concluida: isCompleted })
                        });
                        const result = await res.json();
                        if (!result.success) throw new Error(result.message || 'Erro ao atualizar');
                        card.classList.toggle('completed', isCompleted);
                        updateTaskCounter();
                    } catch (error) {
                        console.error('Falha ao atualizar item:', error);
                        e.target.checked = !isCompleted;
                    }
                } else if (e.target.closest('.delete-btn')) {
                    taskToDeleteId = id;
                    if (confirmDeleteModal) confirmDeleteModal.style.display = 'block';
                } else if (e.target.closest('.task-title')) {
                    card.classList.toggle('is-open');
                }
            });
        }
        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', async () => {
                if (!taskToDeleteId) return;
                try {
                    const res = await fetch(`/api/tarefas/${taskToDeleteId}`, { method: 'DELETE' });
                    const result = await res.json();
                    if (!result.success) throw new Error(result.message);
                    const card = taskList.querySelector(`.task-card[data-id="${taskToDeleteId}"]`);
                    if (card) {
                        card.classList.add('removing');
                        card.style.transition = 'all 0.5s ease';
                        card.style.opacity = '0';
                        card.style.transform = 'translateX(-100px)';
                        setTimeout(() => {
                            card.remove();
                            updateTaskCounter();
                            if (document.querySelectorAll('.task-card').length === 0) {
                                taskList.insertAdjacentHTML('afterend', '<p id="empty-message">ğŸ‰ Nenhum item na lista. Adicione um para comeÃ§ar!</p>');
                            }
                        }, 500);
                    }
                } catch (error) {
                    console.error('Falha ao excluir item:', error);
                } finally {
                    if (confirmDeleteModal) confirmDeleteModal.style.display = 'none';
                    taskToDeleteId = null;
                }
            });
        }
        updateTaskCounter();
    });
</script>